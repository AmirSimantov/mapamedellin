<html>
<head>
    <title>Mapa Onibus</title>
    <link rel="stylesheet" type="text/css" href="libs/chosen.css" />
    <script type="text/javascript" src="libs/underscore-min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="libs/icanhaz.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="libs/backbone-min.js" charset="utf-8" ></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script type="text/javascript" src="libs/chosen.jquery.js"></script>
    
    
    <script id="lineList" type="text/html">
        <select data-placeholder="Escolhe uma linha" style="width:80%;height:10%;" class="chzn-select">
        {{#table}}
            {{#rows}}
                <option value="{{num}}">{{label}}</option>
            {{/rows}}
        {{/table}}
        </select>
    </script>
    
</head>

<body>
    <div id="listlines"></div>
    <div id="map_canvas" style="margin-top:2%;width:100%; height:90%"></div>
    <script>
        function ArrowHandler(map) {
  this.setMap(map);
  // MapCanvasProjection is only available after draw has been called.
  //  this.draw = function() {};
  // Markers with 'head' arrows must be stored
  this.arrowheads = [];
  //all markers stored
  this.arrows = [];
 }

 ArrowHandler.prototype = new google.maps.OverlayView();

 // Draw is inter alia called on zoom change events.
 // So we can use the draw method as zoom change listener
 ArrowHandler.prototype.draw = function() {

  if (this.arrowheads.length > 0) {
   for (var i = 0, m; m = this.arrowheads[i]; i++) {
     m.setOptions({ position: this.usePixelOffset(m.p1, m.p2) });
   }
  }
 };


 // Computes the length of a polyline in pixels
 // to adjust the position of the 'head' arrow
 ArrowHandler.prototype.usePixelOffset = function(p1, p2) {

   var proj = this.getProjection();
   var g = google.maps;
   var dist = 12; // Half size of triangle icon

   var pix1 = proj.fromLatLngToContainerPixel(p1);
   var pix2 = proj.fromLatLngToContainerPixel(p2);
   var vector = new g.Point(pix2.x - pix1.x, pix2.y - pix1.y);
   var length = Math.sqrt(vector.x * vector.x + vector.y * vector.y);
   var normal = new g.Point(vector.x/length, vector.y/length);
   var offset = new g.Point(pix2.x - dist * normal.x, pix2.y - dist * normal.y);

   return proj.fromContainerPixelToLatLng(offset);
 };


  // Returns the triangle icon object
 ArrowHandler.prototype.addIcon = function(file) {
   var g = google.maps;
   var icon = new g.MarkerImage("http://www.google.com/mapfiles/" + file,
    new g.Size(24, 24), null, new g.Point(12, 12));
   return icon;
  };

  // Creates markers with corresponding triangle icons
 ArrowHandler.prototype.create = function(p1, p2, mode,map) {
   var markerpos;
   var g = google.maps;
   if (mode == "onset") markerpos = p1;
   else if (mode == "head") markerpos = this.usePixelOffset(p1, p2);
   else if (mode == "midline") markerpos = g.geometry.spherical.interpolate(p1, p2, .5);

   // Compute the bearing of the line in degrees
   var dir = g.geometry.spherical.computeHeading(p1, p2).toFixed(1);
    // round it to a multiple of 3 and correct unusable numbers
    dir = Math.round(dir/3) * 3;
    if (dir < 0) dir += 240;
    if (dir > 117) dir -= 120;
    // use the corresponding icon
    var icon = this.addIcon("dir_" +dir+ ".png");
    var marker = new g.Marker({position: markerpos,
     map: map, icon: icon, clickable: false
    });
    this.arrows.push(marker);
    if (mode == "head") {
     // Store markers with 'head' arrows to adjust their offset position on zoom change
     marker.p1 = p1;
     marker.p2 = p2;
     this.arrowheads.push(marker);
    }
  };

 ArrowHandler.prototype.load = function (points, mode,map) {
    for (var i = 0; i < points.length-1; i=i+45) {
      var p1 = points[i],
      p2 = points[i + 1];
      this.create(p1, p2, mode,map); 
    }
 };


  // Draws a polyline with accordant arrow heads
  function createPoly(path, mode,setArrows,map) {
   var poly = new google.maps.Polyline({
     strokeColor: "#0000ff",
     strokeOpacity: 0.8,
     strokeWeight: 3,
     map: map,
     path: path });

   setArrows.load(path, mode,map);
   return poly;
  }
    
    
        ich.grabTemplates();
        
        
        var Map = Backbone.Model.extend({
            
            initialize : function() {
                this.myLatlng = new google.maps.LatLng(-3.71969,-38.52562);
                this.myOptions = {
                  zoom: 13,
                  center: this.myLatlng,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                
                this.map = new google.maps.Map(document.getElementById("map_canvas"), this.myOptions);
                this.setArrows=new ArrowHandler(this.map);
                this.lines=[];
                this.fetch();
            },
            url:function() {
                return "https://www.google.com/fusiontables/api/query?sql=SELECT geometry FROM 1628071 WHERE name STARTS WITH '"+this.name+"'&jsonCallback=?"
            },
            parse : function(response) {
                var setArrows=this.setArrows;
                var map=this.map;
                var lines=this.lines;
                
                //remove previous lines
                _.each(lines,function(line) {
                    line.setMap(null);
                });
                //reinit list of lines
                //if(_.last(lines)!=null) lines=[];
                
                //remove all previous arrows
                _.each(setArrows.arrows,function(arrow) {
                    arrow.setMap(null);
                });
                //reinit set of arrows
                setArrows.arrows=[];
                
                //Parse response
                response.table.rows=_.flatten(response.table.rows);
                //For each coordinate, create a gmap.Latlng object, and display it
                response.table.rows=_(response.table.rows).each(function (row){
                    row.coordinates=_(row.coordinates).map(function(coord) {
                        return new google.maps.LatLng(coord[1],coord[0]);
                    });
                    lines.push(createPoly(row.coordinates,"midline",setArrows,map));
                });
                
            },
            displayLine : function(name) {
                this.name=name;
                this.fetch();
            },
        });
        
        

        var LineList = Backbone.Model.extend({
            _view : null,
            
            initialize : function() {
                this.fetch();
                this.bind("change", function() {
                    this._view=new LineListView({model : this});
                    this._view.render();
                });
            },
            url:function() {
                return "https://www.google.com/fusiontables/api/query?sql=SELECT name FROM 1628071&jsonCallback=?"
            },
            parse : function(response) {
                response.table.rows=_.flatten(response.table.rows);
                response.table.rows=_.reject(response.table.rows,function(row) {
                    if(row.split("-")[2]==" Volta") {
                        return true;
                    }
                    else {
                        return false;
                    }
                });
                response.table.rows=_.map(response.table.rows,function(row) {
                    var array=row.split("-");
                    return { num: array[0],label: array[0]+array[1]};
                });
                return response;
            },
        });
        
        var LineListView = Backbone.View.extend({
            el : $("#listlines"),
            render: function() {
                this.el.append(ich.lineList(this.model.toJSON()));
                $(".chzn-select").chosen({no_results_text: "No results matched"}).change(function () {
                     busMap.navigate("line/"+$(".chzn-select").val(),true);
                });
                busMap.navigate("line/"+$(".chzn-select").val(),true);
                return this;
            }
        });
        
        var BusMap = Backbone.Router.extend({
            
            routes : {
                "":             "index",
                "line/:name":   "displayLine"
            },
            
            initialize : function() {
                this._lineList=new LineList();
                this._map=new Map();
            },
            
            index : function() {
            },
            
            displayLine : function(name) {
                this._map.displayLine(name);
            }
            
        });
        
        var busMap=new BusMap();
        
        Backbone.history.start();
        
    </script>

</body>
</html>
