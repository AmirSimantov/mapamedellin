<html>
<head>
    <title>Mapa Onibus</title>
    <link rel="stylesheet" type="text/css" href="libs/chosen.css" />
    <script type="text/javascript" src="libs/underscore-min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="libs/icanhaz.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="libs/backbone-min.js" charset="utf-8" ></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="libs/chosen.jquery.js"></script>
    
    
    <script id="lineList" type="text/html">
        <select data-placeholder="Escolhe uma linha" style="width:80%;height:10%;" class="chzn-select">
        {{#table}}
            {{#rows}}
                <option value="{{num}}">{{label}}</option>
            {{/rows}}
        {{/table}}
        </select>
    </script>
    
</head>

<body>
    <div id="listlines"></div>
    <div id="map_canvas" style="margin-top:2%;width:100%; height:90%"></div>
    <script>
        ich.grabTemplates();
        
        var Map = Backbone.Model.extend({
            
            initialize : function() {
                this.myLatlng = new google.maps.LatLng(-3.71969,-38.52562);
                this.myOptions = {
                  zoom: 13,
                  center: this.myLatlng,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                
                this.map = new google.maps.Map(document.getElementById("map_canvas"), this.myOptions);
            },
            displayLine : function(name) {
                //remove previous layer
                if(this.layer!=null) this.layer.setMap(null);
                this.layer=new google.maps.FusionTablesLayer({
                    query: {
                      select: 'geometry',
                      from: '1628071',
                      where: "name contains '"+name+"'"
                    },
                });
                this.layer.setMap(this.map);
            },
        });
        
        

        var LineList = Backbone.Model.extend({
            _view : null,
            
            initialize : function() {
                this.fetch();
                this.bind("change", function() {
                    this._view=new LineListView({model : this});
                    this._view.render();
                });
            },
            url:function() {
                return "https://www.google.com/fusiontables/api/query?sql=SELECT name FROM 1628071&jsonCallback=?"
            },
            parse : function(response) {
                response.table.rows=_.flatten(response.table.rows);
                response.table.rows=_.reject(response.table.rows,function(row) {
                    if(row.split("-")[2]==" Volta") {
                        return true;
                    }
                    else {
                        return false;
                    }
                });
                response.table.rows=_.map(response.table.rows,function(row) {
                    var array=row.split("-");
                    return { num: array[0],label: array[0]+array[1]};
                });
                return response;
            },
        });
        
        var LineListView = Backbone.View.extend({
            el : $("#listlines"),
            render: function() {
                this.el.append(ich.lineList(this.model.toJSON()));
                $(".chzn-select").chosen({no_results_text: "No results matched"}).change(function () {
                     busMap.navigate("line/"+$(".chzn-select").val(),true);
                });
                busMap.navigate("line/"+$(".chzn-select").val(),true);
                return this;
            }
        });
        
        var BusMap = Backbone.Router.extend({
            
            routes : {
                "":             "index",
                "line/:name":   "displayLine"
            },
            
            initialize : function() {
                this._lineList=new LineList();
                this._map=new Map();
            },
            
            index : function() {
            },
            
            displayLine : function(name) {
                this._map.displayLine(name);
            }
            
        });
        
        var busMap=new BusMap();
        
        Backbone.history.start();
        
    </script>

</body>
</html>
