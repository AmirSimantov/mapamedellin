<html>
<head>
    <meta charset="utf-8">
        
    <title>Mapa de ônibus de Fortaleza</title>
    
    <link rel="stylesheet" type="text/css" href="libs/chosen.css" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="libs/underscore-min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="libs/icanhaz.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="libs/backbone-min.js" charset="utf-8" ></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script type="text/javascript" src="libs/chosen.jquery.js"></script>
    <script type="text/javascript" src="arrows.js"></script>
    
    
    <script id="lineList" type="text/html">
        <p>Escolhe uma linha : <select data-placeholder="Escolhe uma linha" class="chzn-select">
        {{#table}}
            {{#rows}}
                <option value="{{num}}">{{label}}</option>
            {{/rows}}
        {{/table}}
        </select></p>
    </script>
    
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-26151767-1']);
        _gaq.push(['_trackPageview']);
      
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>
    
</head>

<body>
    <h3>Mapa de ônibus de Fortaleza</h3>
    <div id="listlines">
    </div>
    <div id="map_canvas"></div>
    <!-- AddThis Button BEGIN -->
    <div id="map_footer">
        <div class="addthis_toolbox addthis_default_style ">
        <a class="addthis_button_preferred_1"></a>
        <a class="addthis_button_preferred_2"></a>
        <a class="addthis_button_preferred_3"></a>
        <a class="addthis_button_preferred_4"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
        </div>
    </div>
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4e8d941115aebb57"></script>
    <!-- AddThis Button END -->
    <div id="about">
        <h4>About</h4>
        <ul>
        <li>Os dados são do <a href="http://www.fortaleza.ce.gov.br/etufor/index.php?option=com_content&task=view&id=278">etufor</a></li>
        <li>Fontes do aplicativo no <a href="https://github.com/tdurand/mapafortaleza/">Github</a> (pode enviar <a href="https://github.com/tdurand/mapafortaleza/issues/new">sugestão de funcionalidade</a>)</li>
    </div>
    <script>
        ich.grabTemplates();
        
        
        var Map = Backbone.Model.extend({
            
            initialize : function() {
                this.myLatlng = new google.maps.LatLng(-3.71969,-38.52562);
                this.myOptions = {
                  zoom: 13,
                  center: this.myLatlng,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                
                this.map = new google.maps.Map(document.getElementById("map_canvas"), this.myOptions);
                this.setArrows=new ArrowHandler(this.map);
                this.lines=[];
                this.fetch();
            },
            url:function() {
                return "https://www.google.com/fusiontables/api/query?sql=SELECT geometry FROM 1628071 WHERE name STARTS WITH '"+this.name+"'&jsonCallback=?"
            },
            parse : function(response) {
                var setArrows=this.setArrows;
                var map=this.map;
                var lines=this.lines;
                
                //remove previous lines
                _.each(lines,function(line) {
                    line.setMap(null);
                });
                //reinit list of lines
                //if(_.last(lines)!=null) lines=[];
                
                //remove all previous arrows
                _.each(setArrows.arrows,function(arrow) {
                    arrow.setMap(null);
                });
                //reinit set of arrows
                setArrows.arrows=[];
                
                //Parse response
                response.table.rows=_.flatten(response.table.rows);
                //For each coordinate, create a gmap.Latlng object, and display it
                response.table.rows=_(response.table.rows).each(function (row){
                    row.coordinates=_(row.coordinates).map(function(coord) {
                        return new google.maps.LatLng(coord[1],coord[0]);
                    });
                    lines.push(createPoly(row.coordinates,"midline",setArrows,map));
                });
                
            },
            displayLine : function(name) {
                this.name=name;
                this.fetch();
            },
        });
        
        

        var LineList = Backbone.Model.extend({
            _view : null,
            
            initialize : function() {
                this.fetch();
                this.bind("change", function() {
                    this._view=new LineListView({model : this});
                    this._view.render();
                });
            },
            url:function() {
                return "https://www.google.com/fusiontables/api/query?sql=SELECT name FROM 1628071&jsonCallback=?"
            },
            parse : function(response) {
                response.table.rows=_.flatten(response.table.rows);
                response.table.rows=_.reject(response.table.rows,function(row) {
                    if(row.split("-")[2]==" Volta") {
                        return true;
                    }
                    else {
                        return false;
                    }
                });
                response.table.rows=_.map(response.table.rows,function(row) {
                    var array=row.split("-");
                    return { num: array[0],label: array[0]+array[1]};
                });
                return response;
            },
        });
        
        var LineListView = Backbone.View.extend({
            el : $("#listlines"),
            render: function() {
                this.el.append(ich.lineList(this.model.toJSON()));
                $(".chzn-select").chosen({no_results_text: "No results matched"}).change(function () {
                     busMap.navigate("line/"+$(".chzn-select").val(),true);
                });
                busMap.navigate("line/"+$(".chzn-select").val(),true);
                return this;
            }
        });
        
        var BusMap = Backbone.Router.extend({
            
            routes : {
                "":             "index",
                "line/:name":   "displayLine"
            },
            
            initialize : function() {
                this._lineList=new LineList();
                this._map=new Map();
            },
            
            index : function() {
            },
            
            displayLine : function(name) {
                this._map.displayLine(name);
            }
            
        });
        
        var busMap=new BusMap();
        
        Backbone.history.start();
        
    </script>

</body>
</html>
