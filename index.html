

<html>
<head>
    <title>Page Title</title>
    <link rel="stylesheet" type="text/css" href="libs/chosen.css" />
    <script type="text/javascript" src="libs/underscore-min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="libs/icanhaz.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="libs/backbone-min.js" charset="utf-8" ></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="libs/chosen.jquery.js"></script>
    
    
    <script id="lineList" type="text/html">
        <select data-placeholder="Choose a line" style="width:80%;height:10%;" multiple="" tabindex="3" class="chzn-select">
        {{#table}}
            {{%IMPLICIT-ITERATOR iterator=name}}
            {{#rows}}
                <option value="{{name}}">{{name}}</option>
            {{/rows}}
        {{/table}}
        </select>
    </script>
    
</head>

<body>
    <div id="listlines"></div>
    <div id="map_canvas" style="width:100%; height:90%"></div>
    <script>
        ich.grabTemplates();
        
        var Map = Backbone.Model.extend({
            
            initialize : function() {
                this.myLatlng = new google.maps.LatLng(-3.71969,-38.52562);
                this.myOptions = {
                  zoom: 11,
                  center: this.myLatlng,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                
                this.map = new google.maps.Map(document.getElementById("map_canvas"), this.myOptions);
                this.changeLayer();
            },
            changeLayer : function() {
                this.layer=new google.maps.FusionTablesLayer({
                    query: {
                      select: 'geometry',
                      from: '1628071',
                      where: 'name contains "80"'
                    },
                    /*
                    styles: [{
                    polylineOptions: {
                      strokeColor: '#2B1BE0',
                      strokeWeight: 1
                    }
                    }]
                    */
                });
                this.layer.setMap(this.map);
            }
        });
        
        

        var LineList = Backbone.Model.extend({
            _view : null,
            
            initialize : function() {
                this.fetch();
                this.bind("change", function() {
                    this._view=new LineListView({model : this});
                    this._view.render();
                });
            },
            url:function() {
                return "https://www.google.com/fusiontables/api/query?sql=SELECT name FROM 1628071&jsonCallback=?"
            },
            parse : function(response) {
                response.table.rows=_.flatten(response.table.rows);
                return response;
            },
        });
        
        var LineListView = Backbone.View.extend({
            el : $("#listlines"),
            render: function() {
                this.el.append(ich.lineList(this.model.toJSON()));
                $(".chzn-select").chosen({no_results_text: "No results matched"}).change(function () {
                        //alert($(".chzn-select").val());
                });
                return this;
            }
        });
        
        var BusMap = Backbone.Router.extend({
            
            routes : {
                "":             "index",
            },
            
            initialize : function() {
                this._lineList=new LineList();
                this._map=new Map();
            },
            
            index : function() {
            },
            
        });
        
        var busMap=new BusMap();
        
        Backbone.history.start();
        
    </script>

</body>
</html>
